<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MIX-SIGHT Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Barcode Scanning Library -->
    <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.4/umd/zxing-browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a; /* slate-900 */
            --panel-bg: #1e293b; /* slate-800 */
            --panel-border: #334155; /* slate-700 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --accent-color: #2dd4bf; /* teal-400 */
            --accent-hover: #5eead4; /* teal-300 */
            --red-color: #f43f5e; /* rose-500 */
            --green-color: #4ade80; /* green-400 */
            --amber-color: #f59e0b; /* amber-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh */
        }

        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .slide-up { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile-first card styling */
        .summary-card {
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 0.75rem;
            padding: 1rem;
        }

        .cluster-card, .ageing-card {
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-left: 4px solid var(--panel-border);
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.2s ease-in-out;
            user-select: none; /* Prevent text selection on long press */
        }
        .cluster-card[data-selected='true'] {
            border-left-color: var(--accent-color);
            background-color: #334155; /* slate-700 */
        }
        .ageing-card.active, .cluster-card.active {
            transform: scale(0.98);
            background-color: #334155;
        }

        /* Fixed bottom action bar */
        .bottom-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.8));
            padding: 1rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom)); /* For iPhone notches */
            z-index: 10;
        }

        /* Full-screen modal for details/alerts */
        .fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 50;
            display: flex;
            flex-direction: column;
        }
        
        .cutoff-ticker.critical { color: var(--red-color); animation: pulse-text 1.5s infinite; }
        .cutoff-ticker.warning { color: var(--amber-color); }
        .cutoff-ticker.safe { color: var(--green-color); }
        @keyframes pulse-text { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }


        /* Camera Scanner Styles */
        #camera-viewport {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #camera-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        #camera-viewfinder {
            width: 80%;
            max-width: 400px;
            height: 40%;
            max-height: 200px;
            border: 2px solid rgba(255,255,255,0.7);
            border-radius: 1rem;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.6);
            position: relative;
        }
        .scan-line {
            position: absolute;
            left: 5%;
            width: 90%;
            height: 2px;
            background: var(--red-color);
            box-shadow: 0 0 10px var(--red-color);
            animation: scan-line-anim 2.5s linear infinite;
        }
        @keyframes scan-line-anim {
            0% { top: 5%; }
            50% { top: 95%; }
            100% { top: 5%; }
        }
        .bfsi-indicator, .rt-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
            width: 1rem;
            height: 1rem;
            border-radius: 999px;
            margin-left: 0.25rem;
        }
        .bfsi-indicator { background-color: #ca8a04; color: #fefce8; }
        .rt-indicator { background-color: #9333ea; color: #f5f3ff; }
        
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: var(--accent-color);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen">

    <!-- Screen: Upload -->
    <div id="upload-screen" class="h-screen w-screen flex flex-col items-center justify-center p-4">
        <div class="text-center mb-8 fade-in">
            <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-400">MIX-SIGHT</h1>
            <p class="text-slate-300 mt-2">Mobile Edition</p>
        </div>
        <div class="w-full max-w-md mx-auto slide-up space-y-4">
            <label for="csv-upload" id="upload-label" class="w-full cursor-pointer summary-card flex flex-col items-center justify-center p-8">
                <svg class="w-10 h-10 text-slate-500 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                <span class="font-semibold text-lg text-slate-200">Upload Mix-Bag Data</span>
                <span id="file-name" class="text-sm text-slate-400 mt-1 text-center">Tap to select a CSV file</span>
            </label>
            <input type="file" id="csv-upload" class="hidden" accept=".csv, text/csv">
        </div>
        <div id="upload-message" class="mt-4 text-center h-12"></div>
    </div>

    <!-- Screen: Dashboard -->
    <div id="dashboard-screen" class="hidden p-4 pb-28">
        <header class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-2xl font-bold text-white">Dashboard</h1>
                <p id="dashboard-timestamp" class="text-xs text-slate-400">No data loaded</p>
            </div>
            <button id="show-alerts-btn" class="relative p-2 rounded-full bg-slate-800 border border-slate-700">
                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                <span id="alerts-indicator" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-amber-500 text-white text-xs font-bold rounded-full flex items-center justify-center"></span>
            </button>
        </header>

        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="summary-card text-center">
                <p class="text-slate-300 text-sm">Pending Bags</p>
                <p id="total-bags" class="text-4xl font-bold text-teal-400">0</p>
            </div>
            <div class="summary-card text-center">
                <p class="text-slate-300 text-sm">Pending Shipments</p>
                <p id="total-shipments" class="text-4xl font-bold text-blue-400">0</p>
            </div>
        </div>
        <button id="view-all-bags-btn" class="w-full summary-card text-center mb-4 text-teal-300 font-semibold">View All Bags</button>

        <h2 class="text-lg font-bold mt-6 mb-2">Ageing Summary</h2>
        <div id="ageing-summary-list" class="grid grid-cols-2 gap-3 mb-6"></div>

        <h2 class="text-lg font-bold mt-6 mb-2">Next 5 Cutoffs</h2>
        <div id="upcoming-clusters-list" class="space-y-3"></div>
        
        <div id="all-clusters-container" class="hidden">
             <h2 class="text-lg font-bold mt-6 mb-2">Other Clusters</h2>
             <div id="all-clusters-list" class="space-y-3"></div>
        </div>
        
        <button id="toggle-all-clusters-btn" class="w-full text-center mt-4 text-teal-300 font-semibold">View All Clusters</button>

        <div class="bottom-action-bar">
            <button id="start-scan-session-btn" class="w-full bg-teal-500 text-slate-900 font-bold py-4 rounded-lg text-lg">
                Start Scan Session
            </button>
        </div>
    </div>

    <!-- Screen: Scan -->
    <div id="scan-screen" class="hidden fixed inset-0 z-20 bg-black">
        <video id="camera-feed" class="camera-viewport" playsinline></video>
        <div id="camera-overlay">
            <div id="camera-viewfinder"><div class="scan-line"></div></div>
            <p id="camera-status" class="text-white mt-4 bg-black/50 px-3 py-1 rounded-md">Initializing Camera...</p>
        </div>
        <div class="absolute top-4 right-4 left-4 flex justify-between items-center">
             <button id="end-scan-session-btn" class="text-white bg-black/50 py-2 px-4 rounded-lg">End Session</button>
             <button id="toggle-input-btn" class="text-white bg-black/50 p-2 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
             </button>
        </div>
        <div class="absolute bottom-4 left-4 right-4 text-center">
            <div id="last-scan-display" class="text-white text-sm mb-2 h-6"></div>
            <div id="scan-feedback" class="text-6xl font-black text-white/50 transition-all duration-300">READY</div>
        </div>
    </div>

    <!-- Modal for Manual Input -->
    <div id="manual-input-modal" class="hidden fixed inset-0 z-30 bg-black/80 flex items-center justify-center p-4">
        <div class="summary-card w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Manual Bag ID Entry</h3>
            <input type="text" id="scan-input" autocomplete="off" class="bg-slate-900 border-2 border-slate-700 rounded-lg p-4 text-2xl text-center w-full focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Enter Bag ID...">
            <div class="flex gap-2 mt-4">
                <button id="close-manual-input-btn" class="w-full bg-slate-600 text-white py-3 rounded-lg">Cancel</button>
                <button id="submit-manual-input-btn" class="w-full bg-teal-500 text-slate-900 font-bold py-3 rounded-lg">Submit</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Alerts/Details -->
    <div id="details-modal" class="hidden fullscreen-modal slide-up">
        <header class="p-4 flex justify-between items-center border-b border-slate-700 flex-shrink-0">
            <h2 id="details-modal-title" class="text-xl font-bold">Details</h2>
            <button id="close-details-modal-btn" class="text-2xl text-slate-400">&times;</button>
        </header>
        <div id="details-modal-content" class="p-4 overflow-y-auto flex-grow">
            <!-- Content injected here -->
        </div>
        <div id="details-modal-footer" class="p-4 border-t border-slate-700 flex-shrink-0">
            <!-- Footer buttons injected here -->
        </div>
    </div>
    
    <!-- Result Overlay -->
    <div id="result-overlay" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center text-white text-center p-4 transition-all duration-300">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <div class="relative z-10 fade-in">
            <div id="result-status" class="text-8xl font-black"></div>
            <div id="result-bag-id" class="text-4xl font-semibold mt-2 break-all"></div>
            <div id="result-bag-details" class="text-lg mt-4 font-light max-w-md mx-auto"></div>
        </div>
    </div>
    <div id="completion-overlay" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center text-center p-4 bg-gradient-to-br from-teal-500 to-green-600">
        <div class="fade-in">
            <h2 class="text-6xl font-black text-white">ALL TARGETS FOUND!</h2>
            <p class="text-xl text-green-100 mt-4">Great work!</p>
            <button id="finish-session-btn" class="mt-12 bg-white text-green-600 font-bold py-3 px-6 rounded-lg text-lg">
                Return to Dashboard
            </button>
        </div>
    </div>

    <script>
    window.addEventListener('load', () => {

        // --- STATE MANAGEMENT ---
        const state = {
            fullAnalysisData: null,
            scanTargetData: { clusters: new Set(), bags: {}, totalBags: 0, foundBags: 0 },
            isScanning: false,
            isCameraActive: false,
            cameraCodeReader: null,
            isProcessingScan: false,
            appInterval: null,
        };

        // --- ELEMENT SELECTORS ---
        const screens = { upload: document.getElementById('upload-screen'), dashboard: document.getElementById('dashboard-screen'), scan: document.getElementById('scan-screen') };
        const overlays = { result: document.getElementById('result-overlay'), completion: document.getElementById('completion-overlay') };
        const modals = { details: document.getElementById('details-modal'), manualInput: document.getElementById('manual-input-modal') };
        const uploadLabel = document.getElementById('upload-label'), csvUploadInput = document.getElementById('csv-upload'), fileNameEl = document.getElementById('file-name'), uploadMessageEl = document.getElementById('upload-message');
        const totalBagsEl = document.getElementById('total-bags'), totalShipmentsEl = document.getElementById('total-shipments'), dashboardTimestampEl = document.getElementById('dashboard-timestamp'), startScanBtn = document.getElementById('start-scan-session-btn'), showAlertsBtn = document.getElementById('show-alerts-btn'), alertsIndicator = document.getElementById('alerts-indicator'), ageingSummaryListEl = document.getElementById('ageing-summary-list'), viewAllBagsBtn = document.getElementById('view-all-bags-btn');
        const upcomingClustersListEl = document.getElementById('upcoming-clusters-list'), allClustersContainer = document.getElementById('all-clusters-container'), allClustersListEl = document.getElementById('all-clusters-list'), toggleAllClustersBtn = document.getElementById('toggle-all-clusters-btn');
        const endScanBtn = document.getElementById('end-scan-session-btn'), scanFeedbackEl = document.getElementById('scan-feedback'), toggleInputBtn = document.getElementById('toggle-input-btn'), cameraFeed = document.getElementById('camera-feed'), cameraStatus = document.getElementById('camera-status'), lastScanDisplay = document.getElementById('last-scan-display');
        const scanInput = document.getElementById('scan-input'), closeManualInputBtn = document.getElementById('close-manual-input-btn'), submitManualInputBtn = document.getElementById('submit-manual-input-btn');
        const detailsModalTitle = document.getElementById('details-modal-title'), detailsModalContent = document.getElementById('details-modal-content'), closeDetailsModalBtn = document.getElementById('close-details-modal-btn'), detailsModalFooter = document.getElementById('details-modal-footer');
        const resultStatusEl = document.getElementById('result-status'), resultBagIdEl = document.getElementById('result-bag-id'), resultBagDetailsEl = document.getElementById('result-bag-details'), finishSessionBtn = document.getElementById('finish-session-btn');

        // --- AUDIO SETUP ---
        let synths = {};
        function setupSynths() {
            if (Object.keys(synths).length > 0) return;
            synths.success = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 } }).toDestination();
            synths.error = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.5 } }).toDestination();
            synths.nonTarget = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.02, decay: 0.3, sustain: 0.2, release: 0.5 } }).toDestination();
            synths.completion = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" } }).toDestination();
        }

        // --- CORE LOGIC (ANALYSIS) ---
        function performAnalysisInBrowser(csvContent) {
             try {
                const currentTime = new Date();
                const lines = csvContent.trim().split('\n');
                if (lines.length < 2) throw new Error("CSV file is empty or has only a header.");
                const headers = lines[0].trim().split(',').map(h => h.trim().replace(/"/g, '').replace(/ /g, '_').toLowerCase());
                
                const shipments = lines.slice(1).map(line => {
                    const values = line.trim().split(',');
                    let row = {};
                    headers.forEach((header, index) => { row[header] = values[index] ? values[index].trim().replace(/"/g, '') : undefined; });
                    const incomingTime = new Date(row.bag_incoming_time);
                    if (isNaN(incomingTime) || !row.wbn) return null;
                    return { ...row, is_bfsi: ['true', '1'].includes(String(row.is_bfsi).toLowerCase()), bag_incoming_time_dt: incomingTime, age_hours: (currentTime - incomingTime) / 36e5, cluster_id: row.cluster_id || 'UNKNOWN' };
                }).filter(Boolean);

                if (shipments.length === 0) throw new Error("No valid records found.");
                
                const bagAggregates = new Map();
                shipments.forEach(shipment => {
                    if (!bagAggregates.has(shipment.bag_id)) {
                        bagAggregates.set(shipment.bag_id, { bag_id: shipment.bag_id, first_bag_incoming_time_dt: shipment.bag_incoming_time_dt, bag_age_hours: shipment.age_hours, wbns: new Set(), clusters: new Map(), has_bfsi: false, has_rt: false });
                    }
                    const bag = bagAggregates.get(shipment.bag_id);
                    bag.wbns.add(shipment.wbn);
                    bag.clusters.set(shipment.cluster_id, (bag.clusters.get(shipment.cluster_id) || 0) + 1);
                    if (shipment.is_bfsi) bag.has_bfsi = true;
                    if (String(shipment.status).toUpperCase() === 'RT') bag.has_rt = true;
                    if (shipment.bag_incoming_time_dt < bag.first_bag_incoming_time_dt) {
                        bag.first_bag_incoming_time_dt = shipment.bag_incoming_time_dt;
                        bag.bag_age_hours = shipment.age_hours;
                    }
                });

                const bags = Array.from(bagAggregates.values()).map(bag => ({
                    bag_id: bag.bag_id,
                    first_bag_incoming_time_dt: bag.first_bag_incoming_time_dt, // Keep the original time for live calculations
                    age_hours: bag.bag_age_hours,
                    age_str: `${Math.floor(bag.bag_age_hours)}h ${Math.floor((bag.bag_age_hours * 60) % 60)}m`,
                    wbn_count: bag.wbns.size,
                    clusters: Object.fromEntries(bag.clusters.entries()),
                    has_bfsi: bag.has_bfsi,
                    has_rt: bag.has_rt
                }));

                const cluster_details = {};
                bags.forEach(bag => {
                    Object.keys(bag.clusters).forEach(clusterId => {
                        if (!cluster_details[clusterId]) cluster_details[clusterId] = { bag_count: 0, wbn_count: 0, bags: [] };
                        cluster_details[clusterId].bag_count++;
                        cluster_details[clusterId].wbn_count += bag.clusters[clusterId];
                        cluster_details[clusterId].bags.push(bag);
                    });
                });

                const ageing_groups = { "0 to 1 hr": [], "1 to 2 hrs": [], "2 to 4 hrs": [], "4+ hrs": [] };
                bags.forEach(bag => {
                    if (bag.age_hours <= 1) ageing_groups["0 to 1 hr"].push(bag);
                    else if (bag.age_hours <= 2) ageing_groups["1 to 2 hrs"].push(bag);
                    else if (bag.age_hours <= 4) ageing_groups["2 to 4 hrs"].push(bag);
                    else ageing_groups["4+ hrs"].push(bag);
                });

                return { total_pending_bags: bags.length, total_pending_shipments: shipments.length, cluster_details, bags, shipments, ageing_groups };
            } catch (error) {
                console.error("Analysis Error:", error);
                uploadMessageEl.textContent = `Error: ${error.message}`;
                return null;
            }
        }

        // --- UI RENDERING ---
        function showScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if (screens[screenName]) screens[screenName].classList.remove('hidden');
        }

        function renderDashboard() {
            const data = state.fullAnalysisData;
            if (!data) return;

            totalBagsEl.textContent = data.total_pending_bags;
            totalShipmentsEl.textContent = data.total_pending_shipments;
            
            if (state.appInterval) clearInterval(state.appInterval);
            state.appInterval = setInterval(updateLiveElements, 1000);
            updateLiveElements();
            showScreen('dashboard');
        }

        function updateLiveElements() {
            const currentTime = new Date();
            dashboardTimestampEl.textContent = `Live @ ${currentTime.toLocaleTimeString()}`;

            // Recalculate ages
            state.fullAnalysisData.bags.forEach(bag => {
                const incomingTime = new Date(bag.first_bag_incoming_time_dt || 0);
                bag.age_hours = (currentTime - incomingTime) / 36e5;
                bag.age_str = `${Math.floor(bag.age_hours)}h ${Math.floor((bag.age_hours * 60) % 60)}m`;
            });

            const ageing_groups = { "0 to 1 hr": [], "1 to 2 hrs": [], "2 to 4 hrs": [], "4+ hrs": [] };
            state.fullAnalysisData.bags.forEach(bag => {
                if (bag.age_hours <= 1) ageing_groups["0 to 1 hr"].push(bag);
                else if (bag.age_hours <= 2) ageing_groups["1 to 2 hrs"].push(bag);
                else if (bag.age_hours <= 4) ageing_groups["2 to 4 hrs"].push(bag);
                else ageing_groups["4+ hrs"].push(bag);
            });
            state.fullAnalysisData.ageing_groups = ageing_groups;

            ageingSummaryListEl.innerHTML = Object.entries(ageing_groups).map(([category, bags]) => `
                <div class="ageing-card text-center" data-age-category="${category}">
                    <p class="font-bold text-teal-300">${bags.length}</p>
                    <p class="text-xs text-slate-400">${category}</p>
                </div>
            `).join('');

            const allClustersWithCutoff = Object.entries(state.fullAnalysisData.cluster_details).map(([id, details]) => ({
                id, details, nextCutoff: getNextCutoff(id)
            })).filter(c => c.nextCutoff);
            
            allClustersWithCutoff.sort((a, b) => a.nextCutoff - b.nextCutoff);

            const upcomingClusters = allClustersWithCutoff.slice(0, 5);
            const otherClusters = allClustersWithCutoff.slice(5);

            const renderClusterCard = (cluster) => {
                const { id, details, nextCutoff } = cluster;
                const isSelected = document.querySelector(`.cluster-card[data-cluster-id="${id}"]`)?.dataset.selected === 'true';
                const cutoffHtml = nextCutoff ? `<span class="font-semibold cutoff-ticker" data-cutoff-time="${nextCutoff.toISOString()}">--:--:--</span>` : `<span class="text-xs text-slate-500">No cutoff</span>`;
                return `<div class="cluster-card" data-cluster-id="${id}" data-selected="${isSelected}">
                    <div class="flex items-center justify-between">
                        <div class="flex-grow"><h3 class="font-bold text-lg text-teal-300">${id}</h3><p class="text-sm text-slate-300">${details.bag_count} Bags / ${details.wbn_count} WBNs</p></div>
                        <div class="text-right flex-shrink-0 pl-2"><p class="text-xs text-slate-400">Next Cutoff</p>${cutoffHtml}</div>
                    </div></div>`;
            };
            
            upcomingClustersListEl.innerHTML = upcomingClusters.map(renderClusterCard).join('');
            if (otherClusters.length > 0) {
                allClustersListEl.innerHTML = otherClusters.map(renderClusterCard).join('');
                toggleAllClustersBtn.classList.remove('hidden');
            } else {
                toggleAllClustersBtn.classList.add('hidden');
            }
            
            updateCutoffTickers();
            generateAlerts();
        }

        function updateCutoffTickers() {
            const now = new Date();
            document.querySelectorAll('.cutoff-ticker').forEach(ticker => {
                const cutoffTime = new Date(ticker.dataset.cutoffTime);
                const diff = cutoffTime - now;
                if (diff < 0) { ticker.textContent = "Passed"; ticker.className = 'cutoff-ticker text-slate-500 text-xs'; return; }
                const hours = Math.floor(diff / 36e5);
                const minutes = Math.floor((diff % 36e5) / 6e4);
                const seconds = Math.floor((diff % 6e4) / 1000);
                ticker.textContent = `${String(hours).padStart(2, '0')}h ${String(minutes).padStart(2, '0')}m ${String(seconds).padStart(2, '0')}s`;
                let newClass = 'cutoff-ticker font-semibold ';
                if (diff < 2 * 36e5) newClass += 'critical';
                else if (diff < 4 * 36e5) newClass += 'warning';
                else newClass += 'safe';
                ticker.className = newClass;
            });
        }
        
        function renderDetailedBagList(bags, title) {
            detailsModalTitle.textContent = title;
            if (!bags || bags.length === 0) {
                detailsModalContent.innerHTML = `<p class="text-slate-400 text-center py-8">No bags to display.</p>`;
                detailsModalFooter.innerHTML = '';
                return;
            }
            const sortedBags = [...bags].sort((a,b) => b.age_hours - a.age_hours);
            detailsModalContent.innerHTML = sortedBags.map(bag => `
                <div class="summary-card mb-2">
                    <div class="flex justify-between items-start">
                        <div class="font-semibold break-all">${bag.bag_id}
                            ${bag.has_bfsi ? '<span class="bfsi-indicator">$</span>' : ''}
                            ${bag.has_rt ? '<span class="rt-indicator">RT</span>' : ''}
                        </div>
                        <div class="text-right flex-shrink-0 pl-2">
                            <p class="font-bold">${bag.age_str}</p>
                            <p class="text-xs text-slate-400">${bag.wbn_count} WBNs</p>
                        </div>
                    </div>
                </div>
            `).join('');
            detailsModalFooter.innerHTML = `<button id="copy-bag-ids-btn" class="w-full bg-slate-700 text-white font-bold py-3 rounded-lg">Copy ${bags.length} Bag IDs</button>`;
            document.getElementById('copy-bag-ids-btn').onclick = () => {
                const ids = bags.map(b => b.bag_id).join('\n');
                navigator.clipboard.writeText(ids);
                alert(`${bags.length} Bag IDs copied to clipboard!`);
            };
        }

        // --- CAMERA & SCANNING LOGIC ---
        async function startCameraScanner() {
            if (typeof ZXing === 'undefined') {
                cameraStatus.textContent = 'Scanner library not loaded.';
                console.error("ZXing library is not available.");
                return;
            }
            state.cameraCodeReader = new ZXing.BrowserCodeReader();
            cameraStatus.textContent = 'Requesting camera...';
            try {
                const videoInputDevices = await ZXing.BrowserCodeReader.listVideoInputDevices();
                let selectedDeviceId = videoInputDevices[0]?.deviceId;
                const rearCamera = videoInputDevices.find(d => d.label.toLowerCase().includes('back'));
                if (rearCamera) selectedDeviceId = rearCamera.deviceId;
                if (!selectedDeviceId) { cameraStatus.textContent = 'No camera found.'; return; }
                cameraStatus.textContent = 'Scanning...';
                state.cameraCodeReader.decodeFromVideoDevice(selectedDeviceId, 'camera-feed', (result, err) => {
                    if (result && !state.isProcessingScan) processScan(result.getText().toUpperCase());
                    if (err && !(err instanceof ZXing.NotFoundException)) { console.error("ZXing Error:", err); cameraStatus.textContent = `Camera error.`; }
                });
            } catch (err) {
                console.error("Camera Access Error:", err);
                cameraStatus.textContent = 'Please grant camera permission.';
            }
        }

        function stopCameraScanner() {
            if (state.cameraCodeReader) {
                state.cameraCodeReader.reset();
                state.cameraCodeReader = null;
            }
        }

        function processScan(bagId) {
            if (!state.isScanning || state.isProcessingScan) return;
            state.isProcessingScan = true;
            const targetBagData = state.scanTargetData.bags[bagId];
            scanFeedbackEl.classList.remove('text-white/50');
            if (targetBagData) {
                markBagAsFound(bagId);
                showResultOverlay('PRIORITY', bagId, targetBagData, 'from-green-500/80 to-green-600/80');
                synths.success.triggerAttackRelease('C5', '0.5s');
            } else {
                const bagData = state.fullAnalysisData.bags.find(b => b.bag_id === bagId);
                if (bagData) {
                    showResultOverlay('NON-TARGET', bagId, bagData, 'from-slate-500/80 to-slate-600/80');
                    synths.nonTarget.triggerAttackRelease('A3', '0.5s');
                } else {
                    showResultOverlay('NOT IN LIST', bagId, null, 'from-amber-500/80 to-amber-600/80');
                    synths.error.triggerAttackRelease('C3', '0.5s');
                }
            }
            lastScanDisplay.innerHTML = `Last: <span class="${targetBagData ? 'text-green-400' : 'text-amber-400'}">${bagId}</span>`;
        }
        
        function markBagAsFound(bagId) {
            const targetBagData = state.scanTargetData.bags[bagId];
            if (!targetBagData || targetBagData.scanned) return;
            targetBagData.scanned = true;
            state.scanTargetData.foundBags++;
            if (state.scanTargetData.foundBags === state.scanTargetData.totalBags) {
                setTimeout(showCompletion, 2500);
            }
        }

        function showResultOverlay(status, bagId, data, bgClass) {
            resultStatusEl.textContent = status;
            resultBagIdEl.textContent = bagId;
            resultBagDetailsEl.innerHTML = data ? Object.entries(data.clusters).map(([c, n]) => `<div><strong>${n}</strong> for <strong>${c}</strong></div>`).join('') : 'Bag not found in uploaded data.';
            overlays.result.className = `fixed inset-0 z-50 flex flex-col items-center justify-center text-white text-center p-4 transition-all duration-300 ${bgClass}`;
            overlays.result.classList.remove('hidden');
            setTimeout(hideResultOverlay, 2500);
        }

        function hideResultOverlay() {
            overlays.result.classList.add('hidden');
            scanFeedbackEl.textContent = 'READY';
            scanFeedbackEl.classList.add('text-white/50');
            state.isProcessingScan = false;
        }

        function showCompletion() {
            stopCameraScanner();
            overlays.completion.classList.remove('hidden');
            synths.completion.triggerAttackRelease(["C4", "E4", "G4", "C5"], "1s", Tone.now());
        }

        // --- EVENT HANDLERS ---
        function handleFile(file) {
            if (!file || !file.type.match('text/csv')) { uploadMessageEl.textContent = "Please select a valid CSV file."; return; }
            fileNameEl.textContent = file.name;
            uploadMessageEl.innerHTML = `<div class="loader"></div>`;
            setTimeout(() => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    state.fullAnalysisData = performAnalysisInBrowser(event.target.result);
                    if (state.fullAnalysisData) renderDashboard();
                    else uploadMessageEl.textContent = "Failed to analyze file.";
                };
                reader.readAsText(file);
            }, 500);
        }

        function initializeScanSession() {
            const selectedClusters = new Set(Array.from(document.querySelectorAll(".cluster-card[data-selected='true']")).map(card => card.dataset.clusterId));
            if (selectedClusters.size === 0) { showModal('No Selection', '<p>Long-press on one or more clusters to select them for scanning.</p>', () => true); return; }
            state.scanTargetData.clusters = selectedClusters;
            state.scanTargetData.bags = {};
            state.fullAnalysisData.bags.forEach(bag => {
                const hasTargetCluster = Object.keys(bag.clusters).some(c => selectedClusters.has(c));
                if (hasTargetCluster) state.scanTargetData.bags[bag.bag_id] = { ...bag, scanned: false };
            });
            state.scanTargetData.totalBags = Object.keys(state.scanTargetData.bags).length;
            state.scanTargetData.foundBags = 0;
            state.isScanning = true;
            state.isCameraActive = true;
            showScreen('scan');
            startCameraScanner();
        }

        function endSession() {
            stopCameraScanner();
            state.isScanning = false;
            if(state.appInterval) clearInterval(state.appInterval);
            overlays.completion.classList.add('hidden');
            document.querySelectorAll(".cluster-card[data-selected='true']").forEach(card => card.dataset.selected = 'false');
            showScreen('dashboard');
        }
        
        // --- ALERTS LOGIC ---
        const clusterCutoffs = { "HBX-5-Hassan": ["09:30"], "HBX-9-Davangere": ["16:30", "20:30"], "HBX-5-Shimoga": ["18:00"], "HBX-9-Davangere_mix_bag": ["16:30", "20:30"], "HBX-5-Hassan_mix_bag": ["09:30"], "HBX-4-Bhiwandi": ["06:00", "11:30", "18:30", "03:00"], "HBX-6-Gurgaon": ["18:00"], "HBX-3-Kolhapur": ["03:00", "16:30"], "HBX-7-Mangalore": ["09:30"], "HBX-2-Coimbatore_Pudhupalayam_GW": ["23:00"], "HBX-8-Goa": ["16:30"], "HBX-6-Pune_Sudhwadi": ["23:30"] };

        function getNextCutoff(clusterId) {
            const now = new Date();
            const cutoffs = clusterCutoffs[clusterId] || [];
            let nextCutoff = null;
            const todayCutoffs = cutoffs.map(timeStr => { const [h, m] = timeStr.split(':').map(Number); const d = new Date(now); d.setHours(h, m, 0, 0); return d; }).sort((a, b) => a - b);
            for (const cutoff of todayCutoffs) { if (cutoff > now) { nextCutoff = cutoff; break; } }
            if (!nextCutoff && todayCutoffs.length > 0) { nextCutoff = new Date(todayCutoffs[0]); nextCutoff.setDate(nextCutoff.getDate() + 1); }
            return nextCutoff;
        }

        function generateAlerts() {
            if (!state.fullAnalysisData) return;
            const now = new Date();
            let criticalAlerts = [];
            Object.keys(state.fullAnalysisData.cluster_details).forEach(clusterId => {
                const nextCutoff = getNextCutoff(clusterId);
                if (nextCutoff && (nextCutoff - now) < 2 * 36e5) {
                    const atRisk = state.fullAnalysisData.shipments.filter(s => s.cluster_id === clusterId && s.age_hours > 2.5);
                    if (atRisk.length > 0) criticalAlerts.push({ title: `CRITICAL: ${clusterId}`, message: `${atRisk.length} aged shipments risk missing the cutoff in under 2 hours.` });
                }
            });
            const outlierBags = state.fullAnalysisData.bags.filter(b => b.wbn_count >= 7 && b.age_hours >= 7);
            if (outlierBags.length > 0) criticalAlerts.push({ title: `CRITICAL: Outlier Bags`, message: `${outlierBags.length} high-volume, aged bags require immediate attention.` });
            alertsIndicator.textContent = criticalAlerts.length;
            alertsIndicator.classList.toggle('hidden', criticalAlerts.length === 0);
            state.alerts = criticalAlerts;
        }

        function showModal(title, content, onConfirm) {
            const modalId = `modal-${Date.now()}`;
            const modalHTML = `<div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80"><div class="summary-card w-full max-w-sm"><h3 class="text-xl font-bold mb-4">${title}</h3><div class="modal-content">${content}</div><div class="flex justify-end gap-4 mt-6"><button class="modal-confirm-btn text-sm bg-teal-600 text-white py-2 px-4 rounded-md">OK</button></div></div></div>`;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modalElement = document.getElementById(modalId);
            modalElement.querySelector('.modal-confirm-btn').onclick = () => { if(onConfirm) onConfirm(modalElement); modalElement.remove(); };
        }

        // --- EVENT LISTENERS BINDING ---
        csvUploadInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        document.body.addEventListener('click', async () => { if (Tone.context.state !== 'running') await Tone.start(); setupSynths(); }, { once: true });
        startScanBtn.addEventListener('click', initializeScanSession);
        endScanBtn.addEventListener('click', endSession);
        finishSessionBtn.addEventListener('click', endSession);
        
        let pressTimer = null;
        let isLongPress = false;

        screens.dashboard.addEventListener('pointerdown', (e) => {
            const card = e.target.closest('.cluster-card, .ageing-card');
            if (!card) return;
            isLongPress = false;
            card.classList.add('active');
            pressTimer = setTimeout(() => {
                if (card.classList.contains('cluster-card')) {
                    isLongPress = true;
                    const isSelected = card.dataset.selected === 'true';
                    card.dataset.selected = !isSelected;
                    if (navigator.vibrate) navigator.vibrate(50);
                }
            }, 500);
        });

        screens.dashboard.addEventListener('pointerup', (e) => {
            clearTimeout(pressTimer);
            const card = e.target.closest('.cluster-card, .ageing-card');
            if (card) card.classList.remove('active');
            
            if (isLongPress) {
                e.preventDefault(); // Prevent click event after long press
                return;
            }
        });

        screens.dashboard.addEventListener('pointerleave', (e) => {
             clearTimeout(pressTimer);
             const card = e.target.closest('.cluster-card, .ageing-card');
             if(card) card.classList.remove('active');
        }, { capture: true });

        screens.dashboard.addEventListener('click', (e) => {
            const clusterCard = e.target.closest('.cluster-card');
            if (clusterCard) {
                const clusterId = clusterCard.dataset.clusterId;
                const clusterData = state.fullAnalysisData.cluster_details[clusterId];
                if (clusterData) {
                    renderDetailedBagList(clusterData.bags, `Bags for ${clusterId}`);
                    modals.details.classList.remove('hidden');
                }
                return;
            }

            const ageingCard = e.target.closest('.ageing-card');
            if (ageingCard) {
                const category = ageingCard.dataset.ageCategory;
                const bags = state.fullAnalysisData.ageing_groups[category];
                renderDetailedBagList(bags, `Bags: ${category}`);
                modals.details.classList.remove('hidden');
                return;
            }
        });


        viewAllBagsBtn.addEventListener('click', () => {
            renderDetailedBagList(state.fullAnalysisData.bags, 'All Pending Bags');
            modals.details.classList.remove('hidden');
        });

        toggleAllClustersBtn.addEventListener('click', (e) => {
            const isHidden = allClustersContainer.classList.contains('hidden');
            allClustersContainer.classList.toggle('hidden');
            e.target.textContent = isHidden ? 'Show Less' : 'View All Clusters';
        });

        showAlertsBtn.addEventListener('click', () => {
            modals.details.classList.remove('hidden');
            detailsModalTitle.textContent = 'Alerts & Insights';
            let contentHTML = '';
            if (state.alerts && state.alerts.length > 0) {
                contentHTML += state.alerts.map(alert => `<div class="summary-card mb-3 border-l-4 border-amber-500"><h4 class="font-bold text-amber-400">${alert.title}</h4><p class="text-slate-300">${alert.message}</p></div>`).join('');
            } else {
                contentHTML += `<p class="text-slate-400">No active alerts. Great work!</p>`;
            }
            detailsModalContent.innerHTML = contentHTML;
            detailsModalFooter.innerHTML = `<button id="short-wbn-finder-btn" class="w-full bg-slate-700 text-white font-bold py-3 rounded-lg">Identify Potential Short WBNs</button>`;
            document.getElementById('short-wbn-finder-btn').onclick = () => {
                const matchingShipments = state.fullAnalysisData.shipments.filter(s => {
                    const parentBag = state.fullAnalysisData.bags.find(b => b.bag_id === s.bag_id);
                    return parentBag && parentBag.wbn_count <= 5 && parentBag.age_hours >= 4;
                });
                detailsModalTitle.textContent = `Short WBNs Found (${matchingShipments.length})`;
                detailsModalContent.innerHTML = matchingShipments.map(s => `<div class="summary-card mb-2"><p class="font-semibold">${s.wbn}</p><p class="text-sm text-slate-400">In Bag: ${s.bag_id} | Age: ${s.age_hours.toFixed(1)} hrs</p></div>`).join('');
                detailsModalFooter.innerHTML = `<button id="copy-wbn-btn" class="w-full bg-slate-700 text-white font-bold py-3 rounded-lg">Copy ${matchingShipments.length} WBNs</button>`;
                document.getElementById('copy-wbn-btn').onclick = () => {
                    navigator.clipboard.writeText(matchingShipments.map(s => s.wbn).join('\n'));
                    alert(`${matchingShipments.length} WBNs copied!`);
                };
            };
        });

        closeDetailsModalBtn.addEventListener('click', () => modals.details.classList.add('hidden'));
        toggleInputBtn.addEventListener('click', () => modals.manualInput.classList.remove('hidden'));
        closeManualInputBtn.addEventListener('click', () => modals.manualInput.classList.add('hidden'));
        submitManualInputBtn.addEventListener('click', () => {
            const bagId = scanInput.value.trim().toUpperCase();
            if (bagId) processScan(bagId);
            modals.manualInput.classList.add('hidden');
            scanInput.value = '';
        });

        showScreen('upload');
    });
    </script>
</body>
</html>
