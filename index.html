<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MIX-SIGHT Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0e14;
            --panel-bg: #161a22;
            --panel-border: #2c3240;
            --text-primary: #f0f2f5;
            --text-secondary: #8a93a5;
            --accent-color: #2dd4bf;
            --accent-hover: #5eead4;
            --red-color: #f43f5e;
            --amber-color: #f59e0b;
            --blue-color: #38bdf8;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            overscroll-behavior: none;
        }

        /* Screen Transitions */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 64px); /* Full height minus nav bar */
            overflow-y: auto;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
            visibility: hidden;
            opacity: 0;
            transform: translateX(20px);
        }
        .screen.active {
            visibility: visible;
            opacity: 1;
            transform: translateX(0);
        }
        .screen.instant {
            transition: none;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 64px;
            background-color: var(--panel-bg);
            border-top: 1px solid var(--panel-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }
        .nav-item {
            flex: 1;
            text-align: center;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }
        .nav-item.active {
            color: var(--accent-color);
        }
        .nav-item svg {
            margin: 0 auto 4px;
        }
        .nav-item span {
            font-size: 0.75rem;
            font-weight: 500;
        }
        .nav-item.scan-button {
            transform: translateY(-20px);
        }
        .scan-button-inner {
            width: 64px;
            height: 64px;
            border-radius: 999px;
            background: linear-gradient(45deg, var(--accent-color), var(--blue-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 20px rgba(45, 212, 191, 0.3);
            border: 4px solid var(--bg-color);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--panel-bg);
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2001;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        .modal-handle {
            width: 40px;
            height: 4px;
            background-color: var(--panel-border);
            border-radius: 2px;
            margin: 8px auto;
        }

        /* Custom Card/List Styles */
        .summary-card {
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 1rem;
            padding: 1rem;
        }
        .list-item {
            background-color: transparent;
            border-bottom: 1px solid var(--panel-border);
            padding: 1rem;
            transition: background-color 0.2s ease;
        }
        .list-item:active {
            background-color: rgba(45, 212, 191, 0.1);
        }
        .list-item:last-child {
            border-bottom: none;
        }

        /* Scan Screen Specifics */
        #scan-feedback-overlay {
            position: fixed;
            inset: 0;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
            pointer-events: none;
            opacity: 0;
        }
        #scan-feedback-overlay.show {
            opacity: 1;
        }
        
        /* Animations & Vibrant Styles */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 8px 0px var(--amber-color); }
            50% { box-shadow: 0 0 16px 4px rgba(245, 158, 11, 0); }
        }
        .alert-indicator.glowing {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }
        .countdown-timer.critical {
            color: var(--red-color);
            animation: pulse-red 1.5s infinite;
        }
        .countdown-timer.warning { color: var(--amber-color); }
        .countdown-timer.safe { color: var(--accent-color); }
    </style>
</head>
<body class="min-h-screen">

    <!-- Screen: Upload (Initial State) -->
    <div id="upload-screen" class="fixed inset-0 z-[5000] bg-gray-900 flex flex-col items-center justify-center p-4 transition-opacity duration-500">
        <div class="text-center mb-8">
            <h1 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-400">MIX-SIGHT</h1>
            <p class="text-slate-300 mt-2 text-lg">Mobile Operations Dashboard</p>
        </div>
        <div class="w-full max-w-sm mx-auto space-y-4">
            <label for="csv-upload" id="upload-label" class="w-full cursor-pointer bg-slate-800/50 border-2 border-dashed border-slate-600 hover:border-teal-400 flex flex-col items-center justify-center p-8 rounded-2xl transition-colors duration-300">
                <svg class="w-12 h-12 text-slate-500 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
                <span class="font-semibold text-xl text-slate-200">Upload Mix-Bag Data</span>
                <span id="file-name" class="text-sm text-slate-400 mt-1 text-center">Tap to select a CSV file</span>
            </label>
            <input type="file" id="csv-upload" class="hidden" accept=".csv, text/csv">
        </div>
        <div id="upload-message" class="mt-4 text-center h-6"></div>
        <footer class="absolute bottom-4 text-center text-xs text-slate-500">
            Designed & Crafted by Rh. | Team Sonic
        </footer>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <!-- Screen: Dashboard -->
        <main id="dashboard-screen" class="screen p-4 space-y-4">
            <header class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Dashboard</h1>
                    <p id="dashboard-timestamp" class="text-xs text-slate-400">No data loaded</p>
                </div>
                 <div id="live-clock" class="text-lg font-semibold text-slate-300 tabular-nums">00:00:00</div>
            </header>

            <!-- Overall Summary -->
            <div class="grid grid-cols-2 gap-4">
                <div class="summary-card text-center">
                    <p class="text-sm text-slate-400">Total Bags</p>
                    <p id="total-bags" class="text-4xl font-bold text-teal-400">0</p>
                </div>
                <div class="summary-card text-center">
                    <p class="text-sm text-slate-400">Total Shipments</p>
                    <p id="total-shipments" class="text-4xl font-bold text-blue-400">0</p>
                </div>
            </div>

            <!-- Search/Filter -->
            <div class="relative">
                <input type="text" id="search-filter-input" placeholder="Search bags or clusters..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 pl-10 text-white focus:outline-none focus:ring-2 focus:ring-accent-color">
                <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
            </div>
            
            <!-- Ageing Summary -->
            <div class="summary-card">
                <h2 class="text-lg font-semibold mb-2">Ageing Summary</h2>
                <div id="ageing-summary" class="space-y-2"></div>
            </div>

            <!-- Cluster Summary -->
            <div class="summary-card">
                <h2 class="text-lg font-semibold mb-2">Cluster Summary</h2>
                <div id="cluster-summary-list"></div>
            </div>
            <div class="h-8"></div> <!-- Spacer for bottom nav -->
        </main>

        <!-- Screen: Scan -->
        <main id="scan-screen" class="screen flex flex-col p-4">
            <header class="flex justify-between items-center flex-shrink-0">
                <h1 class="text-2xl font-bold">Scan & Sort</h1>
                <button id="end-scan-session-btn" class="text-sm text-slate-400 hover:text-white">End Session</button>
            </header>
            <div class="flex-grow flex flex-col items-center justify-center text-center">
                 <div id="scan-feedback" class="text-6xl font-black text-slate-600 transition-all duration-300">READY</div>
                 <p id="scan-target-info" class="text-slate-400 h-6 mt-1"></p>
            </div>
            <div class="w-full max-w-md mx-auto flex-shrink-0">
                <div id="scan-progress-container" class="mb-4">
                    <div class="flex justify-between items-center mb-1">
                        <span id="progress-text" class="text-sm font-medium text-slate-300">Scan Progress</span>
                        <span id="progress-percentage" class="text-sm font-medium text-slate-300">0%</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-teal-500 h-2.5 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
                <input type="text" id="scan-input" autocomplete="off" class="bg-slate-800 border-2 border-slate-700 rounded-lg p-4 text-2xl text-center w-full focus:outline-none focus:ring-4 focus:ring-teal-500/50" placeholder="Scan or Type Bag ID...">
            </div>
             <div class="h-8"></div> <!-- Spacer for bottom nav -->
        </main>

        <!-- Screen: Alerts -->
        <main id="alerts-screen" class="screen p-4 space-y-4">
            <header>
                <h1 class="text-2xl font-bold">Alerts & Insights</h1>
            </header>
            
            <!-- Cutoff Horizon -->
            <div>
                <h2 class="text-lg font-semibold mb-2 text-slate-300">Upcoming Cutoff Horizon</h2>
                <div id="cutoff-horizon-container" class="flex gap-3 overflow-x-auto pb-3 -mx-4 px-4">
                    <!-- Horizon cards injected here -->
                </div>
            </div>

            <!-- Alerts List -->
            <div id="alerts-list-container" class="space-y-3">
                 <!-- Alerts injected here -->
            </div>
            <div class="h-8"></div> <!-- Spacer for bottom nav -->
        </main>

        <!-- Bottom Navigation Bar -->
        <nav class="bottom-nav">
            <button class="nav-item" data-screen="dashboard-screen">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                <span>Dashboard</span>
            </button>
            <button class="nav-item scan-button" data-screen="scan-screen">
                <div class="scan-button-inner">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804M15 4.804A7.968 7.968 0 0118.5 4c1.255 0 2.443.29 3.5.804m-.708 15.592A7.969 7.969 0 0118.5 20c-1.255 0-2.443-.29-3.5-.804m-6.384 0A7.969 7.969 0 015.5 20c-1.255 0-2.443-.29-3.5-.804m13.084-11.192L15 12l-3-3m-6.084 3L9 12l3 3"></path></svg>
                </div>
            </button>
            <button class="nav-item" data-screen="alerts-screen">
                <div class="relative">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    <span id="alert-indicator" class="absolute top-0 right-0 block h-2 w-2 rounded-full bg-amber-400 hidden"></span>
                </div>
                <span>Alerts</span>
            </button>
        </nav>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Scan Feedback Overlay -->
    <div id="scan-feedback-overlay">
        <div id="scan-result-status" class="text-8xl font-black"></div>
        <div id="scan-result-bag-id" class="text-4xl font-semibold mt-2"></div>
    </div>
    
    <!-- Completion Overlay -->
    <div id="completion-overlay" class="hidden fixed inset-0 z-[4000] flex flex-col items-center justify-center text-center p-4 bg-gradient-to-br from-teal-500 to-green-600">
        <div>
            <h2 class="text-6xl font-black text-white">ALL TARGETS FOUND!</h2>
            <p class="text-xl text-green-100 mt-4">Great work sorting the priority bags.</p>
            <button id="finish-session-btn" class="mt-12 bg-white text-green-600 font-bold py-3 px-6 rounded-lg text-lg">
                Return to Dashboard
            </button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & CONSTANTS ---
        const state = {
            fullAnalysisData: null,
            scanTargetData: { clusters: new Set(), bags: {}, totalBags: 0, foundBags: 0 },
            isScanning: false,
            fileLastModified: null,
            activeScreen: 'dashboard-screen',
            countdownInterval: null,
            clockInterval: null,
            // Set a fixed "now" for consistent demonstration based on user prompt
            now: new Date('2025-08-04T17:58:00+05:30')
        };
        const BAG_URL_PREFIX = "https://hq.delhivery.com/bag/";
        const WBN_URL_PREFIX = "https://hq.delhivery.com/p/pntrzz/";

        // --- DOM ELEMENTS ---
        const uploadScreen = document.getElementById('upload-screen');
        const appContainer = document.getElementById('app-container');
        const screens = {
            'dashboard-screen': document.getElementById('dashboard-screen'),
            'scan-screen': document.getElementById('scan-screen'),
            'alerts-screen': document.getElementById('alerts-screen')
        };
        const navItems = document.querySelectorAll('.nav-item');
        const modalContainer = document.getElementById('modal-container');
        
        const csvUploadInput = document.getElementById('csv-upload');
        const fileNameEl = document.getElementById('file-name');
        const uploadMessageEl = document.getElementById('upload-message');

        const dashboardTimestampEl = document.getElementById('dashboard-timestamp');
        const liveClockEl = document.getElementById('live-clock');
        const totalBagsEl = document.getElementById('total-bags');
        const totalShipmentsEl = document.getElementById('total-shipments');
        const ageingSummaryEl = document.getElementById('ageing-summary');
        const clusterSummaryListEl = document.getElementById('cluster-summary-list');
        const searchFilterInput = document.getElementById('search-filter-input');

        const scanInput = document.getElementById('scan-input');
        const scanFeedbackEl = document.getElementById('scan-feedback');
        const endScanSessionBtn = document.getElementById('end-scan-session-btn');
        const completionOverlay = document.getElementById('completion-overlay');
        const finishSessionBtn = document.getElementById('finish-session-btn');
        const scanFeedbackOverlay = document.getElementById('scan-feedback-overlay');
        const scanResultStatusEl = document.getElementById('scan-result-status');
        const scanResultBagIdEl = document.getElementById('scan-result-bag-id');

        const alertIndicator = document.getElementById('alert-indicator');
        const cutoffHorizonContainer = document.getElementById('cutoff-horizon-container');
        const alertsListContainer = document.getElementById('alerts-list-container');
        
        let synths = {};

        // --- CORE APP LOGIC ---

        function setupSynths() {
            if (Object.keys(synths).length > 0) return;
            synths.success = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 } }).toDestination();
            synths.error = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.5 } }).toDestination();
            synths.nonTarget = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.02, decay: 0.3, sustain: 0.2, release: 0.5 } }).toDestination();
            synths.completion = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" } }).toDestination();
        }

        function showScreen(screenId, isInstant = false) {
            state.activeScreen = screenId;
            Object.values(screens).forEach(s => {
                s.classList.remove('active', 'instant');
                if (isInstant) s.classList.add('instant');
            });
            screens[screenId].classList.add('active');
            
            navItems.forEach(item => {
                const isScanButton = item.classList.contains('scan-button');
                if (isScanButton) {
                    item.querySelector('.scan-button-inner').classList.toggle('bg-slate-700', screenId !== 'scan-screen');
                } else {
                    item.classList.toggle('active', item.dataset.screen === screenId);
                }
            });
        }

        function handleFile(file) {
            if (!file || !file.type.match('text/csv')) {
                if(file) uploadMessageEl.textContent = "Please upload a valid CSV file.";
                return;
            }
            fileNameEl.textContent = file.name;
            state.fileLastModified = file.lastModified;
            uploadMessageEl.textContent = 'Analyzing...';
            
            const reader = new FileReader();
            reader.onload = (event) => {
                setTimeout(() => {
                    state.fullAnalysisData = performAnalysisInBrowser(event.target.result);
                    if (state.fullAnalysisData) {
                        uploadScreen.style.opacity = '0';
                        setTimeout(() => {
                            uploadScreen.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                            renderAll();
                            showScreen('dashboard-screen', true);
                            startTimers();
                        }, 500);
                    }
                }, 50);
            };
            reader.readAsText(file);
        }

        function renderAll() {
            if (!state.fullAnalysisData) return;
            renderDashboard();
            renderAlertsScreen();
        }

        // --- RENDER FUNCTIONS ---

        function animateCountUp(el, endValue) {
            let startValue = 0;
            const duration = 1500;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsedTime = currentTime - startTime;
                if (elapsedTime >= duration) {
                    el.textContent = endValue;
                    return;
                }
                const progress = elapsedTime / duration;
                const currentValue = Math.floor(startValue + (endValue - startValue) * progress);
                el.textContent = currentValue;
                requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        function renderDashboard(filter = '') {
            const data = state.fullAnalysisData;
            if (!data) return;

            const date = new Date(state.fileLastModified);
            dashboardTimestampEl.textContent = `Data from: ${date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' })}`;
            
            animateCountUp(totalBagsEl, data.total_pending_bags);
            animateCountUp(totalShipmentsEl, data.total_pending_shipments);

            ageingSummaryEl.innerHTML = Object.entries(data.ageing_groups).map(([category, values]) => `
                <div class="list-item flex justify-between items-center" data-type="ageing" data-id="${category}">
                    <span class="text-slate-300">${category}</span>
                    <div class="font-semibold text-right">
                        <span class="text-teal-400">${values.bag_count}</span> Bags / 
                        <span class="text-blue-400">${values.wbn_count}</span> WBNs
                    </div>
                </div>
            `).join('');

            const filterLower = filter.toLowerCase();
            const filteredClusters = Object.entries(data.cluster_details)
                .filter(([id]) => id.toLowerCase().includes(filterLower))
                .sort(([,a], [,b]) => b.wbn_count - a.wbn_count);

            clusterSummaryListEl.innerHTML = filteredClusters.map(([id, details]) => `
                <div class="list-item" data-type="cluster" data-id="${id}">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-slate-200 truncate pr-2">${id}</span>
                        <span class="text-sm text-slate-400">${details.bag_count} bags / ${details.wbn_count} WBNs</span>
                    </div>
                </div>
            `).join('');
        }

        function renderAlertsScreen() {
            const { alerts, horizon } = generateAlerts();
            
            cutoffHorizonContainer.innerHTML = horizon.length > 0 ? horizon.map(c => `
                <div class="summary-card flex-shrink-0 w-40 text-center">
                    <div class="font-bold text-teal-300 truncate">${c.clusterId}</div>
                    <div class="text-2xl font-bold text-white tabular-nums countdown-timer" data-cutoff-time="${c.date.toISOString()}">--:--:--</div>
                    <div class="text-xs text-slate-300">${c.pendingShipments} pending</div>
                </div>
            `).join('') : `<p class="text-sm text-slate-400">No upcoming cutoffs found.</p>`;
            
            let hasCritical = false;
            let alertsHTML = '';

            if (alerts.outliers && alerts.outliers.length > 0) {
                hasCritical = true;
                alertsHTML += `<div class="summary-card border-l-4 border-amber-500" data-type="insight" data-id="outliers">...</div>`;
            }

            for (const clusterId in alerts) {
                if (clusterId === 'outliers') continue;
                if (alerts[clusterId].imminent && alerts[clusterId].imminent.length > 0) {
                    hasCritical = true;
                    const imminent = alerts[clusterId].imminent;
                    alertsHTML += `
                        <div class="summary-card border-l-4 border-amber-500" data-type="insight" data-id="${clusterId}">
                            <h3 class="font-bold text-amber-400">CRITICAL: ${clusterId}</h3>
                            <p class="text-sm">${imminent.length} shipments will fail in <span class="font-bold tabular-nums countdown-timer" data-cutoff-time="${imminent[0].cutoff.toISOString()}">--:--:--</span></p>
                        </div>`;
                }
                if (alerts[clusterId].past && alerts[clusterId].past.length > 0) {
                     alertsHTML += `<div class="summary-card border-l-4 border-red-500">...</div>`;
                }
            }
            
            alertsListContainer.innerHTML = alertsHTML || `<p class="text-center text-slate-400 mt-8">No active alerts. All clear!</p>`;
            alertIndicator.classList.toggle('hidden', !hasCritical);
            alertIndicator.classList.toggle('glowing', hasCritical);
        }
        
        // --- All other functions (showModal, showDetailView, scan logic, etc.) remain the same ---
        // ... (Omitting unchanged functions for brevity)
        function renderScanScreen() {
            showModal('Start Scan Session', `...`, (modalEl) => { /* ... */ });
        }
        function updateScanProgress() { /* ... */ }
        function showModal(title, content, onConfirm) { /* ... */ }
        function showDetailView(type, id) { /* ... */ }
        function processScan(bagId) { /* ... */ }
        function markBagAsFound(bagId) { /* ... */ }
        function showScanFeedback(status, bagId, bgClass) { /* ... */ }
        function showCompletion() { /* ... */ }
        function endSession() { /* ... */ }

        // --- EVENT LISTENERS ---
        csvUploadInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        document.body.addEventListener('click', async () => { if (Tone.context.state !== 'running') await Tone.start(); setupSynths(); }, { once: true });
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                if (item.dataset.screen === 'scan-screen' && !state.isScanning) {
                    renderScanScreen();
                } else {
                    showScreen(item.dataset.screen);
                }
            });
        });
        searchFilterInput.addEventListener('input', (e) => renderDashboard(e.target.value));
        document.getElementById('dashboard-screen').addEventListener('click', (e) => {
            const target = e.target.closest('[data-type]');
            if (target) showDetailView(target.dataset.type, target.dataset.id);
        });
        document.getElementById('alerts-screen').addEventListener('click', (e) => {
            const target = e.target.closest('[data-type]');
            if (target) showDetailView(target.dataset.type, target.dataset.id);
        });
        scanInput.addEventListener('change', () => {
            const bagId = scanInput.value.trim().toUpperCase();
            if (bagId) processScan(bagId);
        });
        endScanSessionBtn.addEventListener('click', endSession);
        finishSessionBtn.addEventListener('click', endSession);

        // --- TIMERS & ALERTS ---
        const clusterCutoffs = { "HBX-9-Davangere": ["16:30", "20:30"], "HBX-5-Shimoga": ["18:00"], "HBX-2-Bangalore_Hoskote_GW": ["14:30"], "HBX-4-Bhiwandi": ["06:00", "11:30", "18:30", "03:00"], "HBX-8-Goa": ["16:30"], "HBX-6-Pune_Sudhwadi": ["23:30"] };

        function updateCountdowns() {
            state.now.setSeconds(state.now.getSeconds() + 1); // Simulate time passing
            const now = state.now;
            document.querySelectorAll('.countdown-timer').forEach(timer => {
                const cutoffTime = new Date(timer.dataset.cutoffTime);
                const diff = cutoffTime - now;

                if (diff < 0) {
                    timer.textContent = "CUTOFF PASSED";
                    timer.className = 'countdown-timer text-slate-500 text-xs';
                    return;
                }

                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                timer.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                let newClass = 'countdown-timer font-bold tabular-nums ';
                if (diff < 2 * 3600000) { // Less than 2 hours
                    newClass += 'critical';
                } else if (diff < 4 * 3600000) { // Less than 4 hours
                    newClass += 'warning';
                } else {
                    newClass += 'safe';
                }
                timer.className = newClass;
            });
        }
        
        function startTimers() {
            if (state.clockInterval) clearInterval(state.clockInterval);
            if (state.countdownInterval) clearInterval(state.countdownInterval);

            state.clockInterval = setInterval(() => {
                liveClockEl.textContent = state.now.toLocaleTimeString('en-US', { timeZone: 'Asia/Kolkata', hour12: false });
            }, 1000);

            state.countdownInterval = setInterval(updateCountdowns, 1000);
            
            // Re-render alerts every 30s to catch new ones
            setInterval(() => {
                if(state.fullAnalysisData) renderAlertsScreen();
            }, 30000);
        }

        function generateAlerts() {
            if (!state.fullAnalysisData) return { alerts: {}, horizon: [] };
            const now = state.now;
            const alerts = {};
            const atRiskShipments = state.fullAnalysisData.shipments.filter(s => s.age_hours >= 2.5);
            for (const shipment of atRiskShipments) {
                const cutoffs = clusterCutoffs[shipment.cluster_id] || [];
                if (cutoffs.length === 0) continue;
                let nextCutoff = null;
                for (const timeStr of cutoffs.sort()) {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    const cutoffToday = new Date(now);
                    cutoffToday.setHours(hours, minutes, 0, 0);
                    if (cutoffToday < now) cutoffToday.setDate(cutoffToday.getDate() + 1); // Move to next day if passed
                    if (!nextCutoff || cutoffToday < nextCutoff) nextCutoff = cutoffToday;
                }
                if (!alerts[shipment.cluster_id]) alerts[shipment.cluster_id] = { imminent: [], past: [] };
                if (nextCutoff && (nextCutoff - now) < 4 * 3600000) { // Alert if within 4 hours
                    alerts[shipment.cluster_id].imminent.push({shipment, cutoff: nextCutoff});
                }
            }
            
            const upcomingCutoffs = [];
            const processedClusters = new Set();
            Object.entries(clusterCutoffs).flatMap(([clusterId, times]) => times.map(time => ({ clusterId, time }))).map(item => {
                const [hours, minutes] = item.time.split(':').map(Number);
                const cutoffDate = new Date(now);
                cutoffDate.setHours(hours, minutes, 0, 0);
                if (cutoffDate < now) cutoffDate.setDate(cutoffDate.getDate() + 1);
                return { ...item, date: cutoffDate };
            }).sort((a, b) => a.date - b.date).forEach(cutoff => {
                if (upcomingCutoffs.length >= 5) return;
                if (!processedClusters.has(cutoff.clusterId)) {
                    const pendingShipments = state.fullAnalysisData.shipments.filter(s => s.cluster_id === cutoff.clusterId).length;
                    upcomingCutoffs.push({ ...cutoff, pendingShipments });
                    processedClusters.add(cutoff.clusterId);
                }
            });

            return { alerts, horizon: upcomingCutoffs };
        }
        
        function performAnalysisInBrowser(csvContent) {
            try {
                const lines = csvContent.trim().split('\n');
                const headers = lines[0].trim().split(',').map(h => h.trim().replace(/"/g, '').replace(/ /g, '_').toLowerCase());
                const currentTime = state.now;
                const shipments = lines.slice(1).map(line => {
                    const values = line.trim().split(',');
                    let row = {};
                    headers.forEach((header, index) => { row[header] = values[index] ? values[index].trim().replace(/"/g, '') : undefined; });
                    const incomingTime = new Date(row.bag_incoming_time);
                    if (isNaN(incomingTime) || !row.wbn) return null;
                    return { ...row, bag_incoming_time_dt: incomingTime, age_hours: (currentTime - incomingTime) / 3600000, cluster_id: row.cluster_id || 'UNKNOWN' };
                }).filter(Boolean);
                const bagAggregates = new Map();
                shipments.forEach(shipment => {
                    if (!bagAggregates.has(shipment.bag_id)) {
                        bagAggregates.set(shipment.bag_id, { bag_id: shipment.bag_id, first_bag_incoming_time_dt: shipment.bag_incoming_time_dt, bag_age_hours: shipment.age_hours, wbns: new Set(), clusters: new Map() });
                    }
                    const bag = bagAggregates.get(shipment.bag_id);
                    bag.wbns.add(shipment.wbn);
                    bag.clusters.set(shipment.cluster_id, (bag.clusters.get(shipment.cluster_id) || 0) + 1);
                    if (shipment.bag_incoming_time_dt < bag.first_bag_incoming_time_dt) {
                        bag.first_bag_incoming_time_dt = shipment.bag_incoming_time_dt;
                        bag.bag_age_hours = shipment.age_hours;
                    }
                });
                const bags = Array.from(bagAggregates.values()).map(bag => ({ bag_id: bag.bag_id, age_hours: bag.bag_age_hours, age_str: `${Math.floor(bag.bag_age_hours)}h ${Math.floor((bag.bag_age_hours * 60) % 60)}m`, wbn_count: bag.wbns.size, clusters: Object.fromEntries(bag.clusters.entries()) }));
                const cluster_details = {};
                bags.forEach(bag => {
                    Object.keys(bag.clusters).forEach(clusterId => {
                        if (!cluster_details[clusterId]) cluster_details[clusterId] = { bag_count: 0, wbn_count: 0, bags: [] };
                        cluster_details[clusterId].bag_count++;
                        cluster_details[clusterId].wbn_count += bag.clusters[clusterId];
                        cluster_details[clusterId].bags.push(bag);
                    });
                });
                const ageing_groups = { "0 to 1 hr": { bag_count: 0, wbn_count: 0, bags: [] }, "1 to 2 hrs": { bag_count: 0, wbn_count: 0, bags: [] }, "2 to 4 hrs": { bag_count: 0, wbn_count: 0, bags: [] }, "4+ hrs": { bag_count: 0, wbn_count: 0, bags: [] } };
                bags.forEach(bag => {
                    let groupName;
                    if (bag.age_hours <= 1) groupName = "0 to 1 hr";
                    else if (bag.age_hours <= 2) groupName = "1 to 2 hrs";
                    else if (bag.age_hours <= 4) groupName = "2 to 4 hrs";
                    else groupName = "4+ hrs";
                    ageing_groups[groupName].bag_count++;
                    ageing_groups[groupName].wbn_count += bag.wbn_count;
                });
                return { total_pending_bags: bags.length, total_pending_shipments: shipments.length, ageing_groups, cluster_details, bags, shipments };
            } catch (error) {
                uploadMessageEl.textContent = `Error: ${error.message}`;
                return null;
            }
        }
    });
    </script>
</body>
</html>
